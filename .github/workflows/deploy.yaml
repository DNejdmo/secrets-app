name: CI/CD to Minikube

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Minikube
        uses: medyagh/setup-minikube@master

      - name: Build image inside Minikube
        run: |
          minikube image build -t secrets-app:latest .

      - name: Install External Secrets
        run: |
          helm repo add external-secrets https://charts.external-secrets.io
          helm repo update
          helm upgrade --install external-secrets external-secrets/external-secrets \
            --namespace external-secrets --create-namespace \
            --wait --timeout=300s

      - name: Wait for External Secrets webhook
        run: |
          kubectl wait --for=condition=available deployment/external-secrets-webhook -n external-secrets --timeout=120s

      # ──────────────────────────────────────────────────────
      # Installera Vault + skapa token + unseal automatiskt
      # ──────────────────────────────────────────────────────
      - name: Deploy Vault + auto-unseal with GitHub secrets
        env:
          UNSEAL_KEY_1: ${{ secrets.VAULT_UNSEAL_KEY_1 }}
          UNSEAL_KEY_2: ${{ secrets.VAULT_UNSEAL_KEY_2 }}
          UNSEAL_KEY_3: ${{ secrets.VAULT_UNSEAL_KEY_3 }}
          VAULT_ROOT_TOKEN: ${{ secrets.VAULT_ROOT_TOKEN }}  # Backup if needed
        run: |
          echo "Deploying Vault..."
          kubectl apply -f https://raw.githubusercontent.com/hashicorp/vault-helm/main/examples/minikube/vault-dev.yaml

          echo "Waiting for Vault pod..."
          kubectl wait --for=condition=ready pod/vault-0 -n vault --timeout=180s

          echo "Auto-unsealing Vault..."
          kubectl exec -n vault vault-0 -- vault operator unseal $UNSEAL_KEY_1
          kubectl exec -n vault vault-0 -- vault operator unseal $UNSEAL_KEY_2
          kubectl exec -n vault vault-0 -- vault operator unseal $UNSEAL_KEY_3

          echo "Creating vault-token secret for ESO..."
          # Hämta root-token från podden och lägg i secret
          ROOT_TOKEN=$(kubectl exec -n vault vault-0 -- cat /home/vault/.vault-token)
          kubectl create secret generic vault-token \
            --namespace external-secrets \
            --from-literal=token=$ROOT_TOKEN \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "Putting real secret into Vault..."
          kubectl exec -n vault vault-0 -- vault kv put secret/myapp api-key=open-source-hemlighet-54321

      # ──────────────────────────────────────────────────────
      # Deploya appen och vänta
      # ──────────────────────────────────────────────────────
      - name: Deploy application
        run: |
          kubectl apply -f k8s-manifests.yaml
          kubectl apply -f app-deployment.yaml

          echo "Waiting for External Secrets to sync from Vault..."
          sleep 20

          kubectl rollout status deployment/secrets-app -n default --timeout=180s

      # ──────────────────────────────────────────────────────
      # Verifiera att det är den riktiga hemligheten (inte mock)
      # ──────────────────────────────────────────────────────
      - name: Verify real Vault secret is injected
        run: |
          API_KEY=$(kubectl get secret app-secret -n default -o jsonpath='{.data.API_KEY}' | base64 -d)
          echo "Injected API_KEY = '$API_KEY'"
          
          if [[ "$API_KEY" == "open-source-hemlighet-54321" ]]; then
            echo "SUCCESS: Real Vault secret is correctly injected!"
          else
            echo "FAIL: Got wrong value"
            exit 1
          fi