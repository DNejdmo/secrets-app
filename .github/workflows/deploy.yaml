name: CI/CD to Minikube – Real Vault (fast & safe)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Minikube
        uses: medyagh/setup-minikube@master

      - name: Build image
        run: |
          minikube image build -t secrets-app:latest .

      - name: Install External Secrets Operator
        run: |
          helm repo add external-secrets https://charts.external-secrets.io
          helm repo update
          helm upgrade --install external-secrets external-secrets/external-secrets \
            --namespace external-secrets --create-namespace --wait --timeout=300s

      - name: Wait for webhook
        run: kubectl wait --for=condition=available deployment/external-secrets-webhook -n external-secrets --timeout=120s

      # ──────── Vault i dev-mode (rätt token-path 2025) ────────
      - name: Install Vault (dev mode – fast & reliable)
        env:
          DEMO_API_KEY: ${{ secrets.DEMO_VAULT_SECRET }}
        run: |
          helm repo add hashicorp https://helm.releases.hashicorp.com || true
          helm repo update

          helm upgrade --install vault hashicorp/vault \
            --namespace vault --create-namespace \
            --set "server.dev.enabled=true" \
            --set "server.dev.rootToken=root" \
            --set "injector.enabled=false" \
            --wait --timeout=300s

          kubectl wait --for=condition=ready pod/vault-0 -n vault --timeout=180s

          # NYTT: Två säkra sätt att hämta token (en av dem funkar alltid)
          if ROOT_TOKEN=$(kubectl exec -n vault vault-0 -- printenv ROOT_TOKEN 2>/dev/null); then
            echo "Using ROOT_TOKEN from env"
          else
            ROOT_TOKEN="root"  # fallback – vi satte den med --set ovan
          fi

          # Skapa secret för ESO
          kubectl create secret generic vault-token \
            --namespace external-secrets \
            --from-literal=token="$ROOT_TOKEN" \
            --dry-run=client -o yaml | kubectl apply -f -

          # Lägg in hemlighet
          if [ -n "$DEMO_API_KEY" ]; then
            kubectl exec -n vault vault-0 -- vault kv put secret/myapp api-key="$DEMO_API_KEY"
          else
            kubectl exec -n vault vault-0 -- vault kv put secret/myapp api-key="open-source-hemlighet-54321"
          fi

      - name: Deploy app
        run: |
          kubectl apply -f k8s-manifests.yaml
          kubectl apply -f app-deployment.yaml
          sleep 25
          kubectl rollout status deployment/secrets-app -n default --timeout=180s

      - name: Verify success
        run: |
          API_KEY=$(kubectl get secret app-secret -n default -o jsonpath='{.data.API_KEY}' | base64 -d)
          echo "API_KEY length: ${#API_KEY}"
          [[ "$API_KEY" == "open-source-hemlighet-54321" || "$API_KEY" == "$DEMO_API_KEY" ]] && echo "SUCCESS: Real Vault secret injected!" || exit 1